<head>
 <meta http-equiv="X-UA-Compatible" content="IE=EDGE"/>
 <meta http-equiv="Content-Type" content="text/html;"/>
 <meta name="Generator" content="Xara HTML filter v.8.1.1.474"/>
 <meta name="XAR Files" content="supervisorio/blocoi/xr_files.txt"/>
 <title>blocoi</title>
 <meta name="viewport" content="width=device-width, initial-scale=1" />
 <link rel="stylesheet" type="text/css" href="supervisorio/blocoi/xr_fonts.css"/>
 <script type="text/javascript"><!--
 if(navigator.userAgent.indexOf('MSIE')!=-1 || navigator.userAgent.indexOf('Trident')!=-1){ document.write('<link rel="stylesheet" type="text/css" href="supervisorio/blocoi/xr_fontsie.css"/>');}
 --></script>
 <script language="JavaScript" type="text/javascript">document.documentElement.className="xr_bgh0";</script>
 <link rel="stylesheet" type="text/css" href="supervisorio/blocoi/xr_main.css"/>
 <link rel="stylesheet" type="text/css" href="supervisorio/blocoi/xr_text.css"/>
 <link rel="stylesheet" type="text/css" href="supervisorio/blocoi/custom_styles.css"/>
 <script type="text/javascript" src="supervisorio/blocoi/roe.js"></script>
 <script type="text/javascript" src="supervisorio/blocoi/replaceMobileFonts.js"></script>
<script src="../inc/js/jquery/jquery-1.11.2.min.js"></script>
 <link rel="stylesheet" type="text/css" href="supervisorio/blocoi/ani.css"/>
</head>
<div style="color: #333;font-size: 18px; float: right;"><?=date("d/m/Y H:i:s");?><br>
	<span id="referencia"></span>
</div>
<div id="xr_td" class="xr_td">
	<div class="xr_ap xr_xri_" style="width: 1000px; height: 760px;">
		<img class="xr_rn_ xr_ap" src="supervisorio/blocoi/blocoi.jpg" title="" style="left: 0px; top: 66px; width: 1250px; height: 644px;"/>
		
		<a class="toogleimg">
			<span class="xr_ar 345" style="left: 445px; top: 165px; width: 60px; height: 19px; background-color: #F8BB00; border: 1px solid #333333;" id="345"></span>
			<div class="Normal_text" style="position: absolute; left:459px; top:180px; width:24px; height:10px;color:#333333;">
				<span class="xr_tl Normal_text" style="top: -11.77px;color:#333333;font-size:12px;" id="content_345"></span>  
			</div>
			<div class="Normal_text  grafana" style="position: absolute; left:448px; top:189px; width:24px; height:10px;color:#333333; z-index:9999" data-href="">
				<img class="img_345" src="supervisorio/grafana.png"  style="display:none;"/>		
			</div>
			<div class="Normal_text  detalhes" style="position: absolute; left:470px; top:190px; width:24px; height:10px;color:#333333; z-index:9999" data-href=""> 
				<img class="img_345" src="supervisorio/detalhes.png"  style="display:none;"/>
			</div>
			<div class="Normal_text  relatorio" style="position: absolute; left:487px; top:189px; width:24px; height:10px;color:#333333; z-index:9999" data-href="">  
				<img href="" class="img_345" src="supervisorio/relatorio.png"  style="display:none;"/>	
			</div>
			<span class="img_345" style=" position: absolute; left:445px; top:192px; width: 60px; height: 19px; background-color: #fff; border: 1px solid #333333; margin-top:-5px; display:none;"></span>
		</a>

		<a class="toogleimg">
			<span class="xr_ar 349" style="left: 719px; top: 165px; width: 60px; height: 19px; background-color: #F8BB00; border: 1px solid #333333;" id="349"></span>
			<div class="Normal_text" style="position: absolute; left: 733px; top: 180px; width:24px; height:10px;color:#333333;">
				<span class="xr_tl Normal_text" style="top: -11.77px;color:#333333;font-size:12px;" id="content_349"></span> 
			</div>
			<div class="Normal_text  grafana" style="position: absolute; left:722px; top:189px; width:24px; height:10px;color:#333333; z-index:9999" data-href="">
				<img class="img_349" src="supervisorio/grafana.png"  style="display:none;"/>		
			</div>
			<div class="Normal_text  detalhes" style="position: absolute; left:744px; top:190px; width:24px; height:10px;color:#333333; z-index:9999" data-href=""> 
				<img class="img_349" src="supervisorio/detalhes.png"  style="display:none;"/>
			</div>
			<div class="Normal_text  relatorio" style="position: absolute; left:761px; top:189px; width:24px; height:10px;color:#333333; z-index:9999" data-href="">  
				<img href="" class="img_349" src="supervisorio/relatorio.png"  style="display:none;"/>	
			</div>
			<span class="img_349" style=" position: absolute; left:719px; top:192px; width: 60px; height: 19px; background-color: #fff; border: 1px solid #333333; margin-top:-5px; display:none;"></span>
		</a>

		<a class="toogleimg">
			<span class="xr_ar 351" style="left: 856px; top: 165px; width: 60px; height: 19px; background-color: #F8BB00; border: 1px solid #333333;" id="351"></span>
			<div class="Normal_text" style="position: absolute; left: 870px; top: 180px; width:24px; height:10px;color:#333333;">
				<span class="xr_tl Normal_text" style="top: -11.77px;color:#333333;font-size:12px;" id="content_351"></span>
			</div>
			<div class="Normal_text  grafana" style="position: absolute; left:859px; top:189px; width:24px; height:10px;color:#333333; z-index:9999" data-href="">
				<img class="img_351" src="supervisorio/grafana.png"  style="display:none;"/>		
			</div>
			<div class="Normal_text  detalhes" style="position: absolute; left:881px; top:190px; width:24px; height:10px;color:#333333; z-index:9999" data-href=""> 
				<img class="img_351" src="supervisorio/detalhes.png"  style="display:none;"/>
			</div>
			<div class="Normal_text  relatorio" style="position: absolute; left:898px; top:189px; width:24px; height:10px;color:#333333; z-index:9999" data-href="">  
				<img href="" class="img_351" src="supervisorio/relatorio.png"  style="display:none;"/>	
			</div>
			<span class="img_351" style=" position: absolute; left:856px; top:192px; width: 60px; height: 19px; background-color: #fff; border: 1px solid #333333; margin-top:-5px; display:none;"></span>
		</a>

		<a class="toogleimg">
			<span class="xr_ar 353" style="left: 994px; top: 165px; width: 60px; height: 19px; background-color: #F8BB00; border: 1px solid #333333;" id="353"></span>
			<div class="Normal_text" style="position: absolute; left: 1008px; top: 180px; width:24px; height:10px;color:#333333;">
				<span class="xr_tl Normal_text" style="top: -11.77px;color:#333333;font-size:12px;" id="content_353"></span> 
			</div>
			<div class="Normal_text  grafana" style="position: absolute; left:997px; top:189px; width:24px; height:10px;color:#333333; z-index:9999" data-href="">
				<img class="img_353" src="supervisorio/grafana.png"  style="display:none;"/>		
			</div>
			<div class="Normal_text  detalhes" style="position: absolute; left:1019px; top:190px; width:24px; height:10px;color:#333333; z-index:9999" data-href=""> 
				<img class="img_353" src="supervisorio/detalhes.png"  style="display:none;"/>
			</div>
			<div class="Normal_text  relatorio" style="position: absolute; left:1036px; top:189px; width:24px; height:10px;color:#333333; z-index:9999" data-href="">  
				<img href="" class="img_353" src="supervisorio/relatorio.png"  style="display:none;"/>	
			</div>
			<span class="img_353" style=" position: absolute; left:994px; top:192px; width: 60px; height: 19px; background-color: #fff; border: 1px solid #333333; margin-top:-5px; display:none;"></span>
		</a>

		<a class="toogleimg">
			<span class="xr_ar 355" style="left: 1131px; top: 165px; width: 60px; height: 19px; background-color: #F8BB00; border: 1px solid #333333;" id="355"></span>
			<div class="Normal_text" style="position: absolute; left: 1145px; top: 180px; width:24px; height:10px;color:#333333;">
				<span class="xr_tl Normal_text" style="top: -11.77px;color:#333333;font-size:12px;" id="content_355"></span>
			</div>
			<div class="Normal_text  grafana" style="position: absolute; left:1134px; top:189px; width:24px; height:10px;color:#333333; z-index:9999" data-href="">
				<img class="img_355" src="supervisorio/grafana.png"  style="display:none;"/>		
			</div>
			<div class="Normal_text  detalhes" style="position: absolute; left:1156px; top:190px; width:24px; height:10px;color:#333333; z-index:9999" data-href=""> 
				<img class="img_355" src="supervisorio/detalhes.png"  style="display:none;"/>
			</div>
			<div class="Normal_text  relatorio" style="position: absolute; left:1173px; top:189px; width:24px; height:10px;color:#333333; z-index:9999" data-href="">  
				<img href="" class="img_355" src="supervisorio/relatorio.png"  style="display:none;"/>	
			</div>
			<span class="img_355" style=" position: absolute; left:1131px; top:192px; width: 60px; height: 19px; background-color: #fff; border: 1px solid #333333; margin-top:-5px; display:none;"></span>
		</a>
	</div>
</div>

<?

include_once("../inc/php/functions.php");

if($_GET['elemento'] == 'pressao'){
	$variavel = 'kgsCx6bMk';
}else if($_GET['elemento'] == 'temperatura' || ($_GET['elemento'] == 'umidade')){
	$variavel = '12J7febGz';
}

$getsala = $_GET['sala'];

$sql = "select 
			d.iddevice, s.idtag,
		IF(s.idtag = '".$getsala."','selecionada','') as salaselecionada
		FROM
			tag s
		join tagsala ts on ts.idtagpai = s.idtag
		join device d on d.idtag = ts.idtag
		WHERE
			s.idtag in (345,349,351,353,355)
		and d.status = 'ATIVO'
		and s.status = 'ATIVO'";

$res = d::b()->query($sql);

while ($linha = mysql_fetch_assoc($res))
{
	if ($_GET['elemento'] == 'pressao')
	{
		$sql = "Select 
				dhr.registradoem, if (dhr.registradoem < (NOW() - INTERVAL 5 MINUTE), 'INATIVO', 'ATIVO') as statusleitura,
				ROUND(IF(dhr.pressao > 0 AND dhrr.pressao > 0,
							(dhr.pressao + d.calib_press) - (dhrr.pressao + dr.calib_press),
							0),
						0) AS pressao
				FROM
				laudo.devicehistref dhr
					JOIN
				laudo.device d ON d.iddevice = dhr.iddevice
					JOIN
				laudo.devicehistref dhrr ON dhrr.iddevice = dhr.iddeviceref
					AND dhr.registradoem = dhrr.registradoem
					JOIN
				laudo.device dr ON dr.iddevice = dhrr.iddevice
				WHERE
				d.iddevice = ".$linha['iddevice']."
				ORDER BY dhr.registradoem DESC
				LIMIT 1";

	}else if ($_GET['elemento'] == 'temperatura')
	{
		$sql = "Select
				ROUND(dh.temperatura - calib_temp,0) AS temperatura, dh.registradoem, if (registradoem < (NOW() - INTERVAL 5 MINUTE), 'INATIVO', 'ATIVO') as statusleitura
				FROM
					laudo.devicehist dh
						JOIN
					laudo.device d ON d.mac_address = dh.mac_address
				WHERE
					d.iddevice = ".$linha['iddevice']."
				ORDER BY dh.registradoem DESC
				LIMIT 1";
	}else if ($_GET['elemento'] == 'umidade')
	{ 
		$sql = "Select
				ROUND(dh.umidade - calib_umid,0) AS umidade, dh.registradoem, if (registradoem < (NOW() - INTERVAL 5 MINUTE), 'INATIVO', 'ATIVO') as statusleitura
				FROM
					laudo.devicehist dh
						JOIN
					laudo.device d ON d.mac_address = dh.mac_address
				WHERE
					d.iddevice = ".$linha['iddevice']."
				ORDER BY dh.registradoem DESC
				LIMIT 1";
	}

	$res2 = d::b()->query($sql);

	while ($_row = mysql_fetch_assoc($res2))
	{ 
		$idtagpai = $linha['idtag']; 
		$statusleitura = $_row['statusleitura'];
		$registradoem = $_row['registradoem'];
		$iddevice = $linha['iddevice'];
		$bgcolor='#F8BB00';

		if ($_GET['elemento'] == 'temperatura'){
			$temperatura = $_row['temperatura'];
			$dado = $temperatura.' °C';
		}else if ($_GET['elemento'] == 'pressao'){
			$pressao = $_row['pressao'];
			$dado = $pressao.' Pa';  
		}elseif ($_GET['elemento'] == 'umidade'){ 
			$umidade = $_row['umidade']; 
			$dado = $umidade.' UR';
		}

		if ($linha['salaselecionada'] == "selecionada"){
			$bgcolor='#07fca2';
		}
		
		if ($statusleitura == 'INATIVO'){
			$pressao = '------'; 
			$temperatura = '------'; 
			$umidade = '------';
			$bgcolor='#e74a3b';
		}
		
		?>
		<script>
			$('#referencia').html('<small>Referência: tag-<?='1789';?> <?=$referencia;?></small>');
			$('.<?=$idtagpai;?>').css('background', '<?=$bgcolor;?>');
			$('#content_<?=$idtagpai;?>').html('<?=$dado;?>');
		</script>
		<?
	}

	?>
	<script>
		$('#<?=$idtagpai;?>').siblings('.grafana').attr('data-href','http://h1.laudo.io:480/graph/d/<?=$variavel?>/bloco-i-<?=$_GET['elemento']?>?orgId=1').attr('title', 'Grafana');
		$('#<?=$idtagpai;?>').siblings('.detalhes').attr('data-href','https://sislaudo.laudolab.com.br/?_modulo=device&_acao=u&iddevice=<?=$iddevice;?>').attr('title', 'Editar Device');
		$('#<?=$idtagpai;?>').siblings('.relatorio').attr('data-href','https://sislaudo.laudolab.com.br/?_modulo=device').attr('title', 'Relatório Device');
	</script>

	<?
}
?>

<script>

$('.toogleimg').on('mouseover', function(){
	var id = $(this).children('span').attr('id');
	$('.img_'+id).css('display', '');
});
$('.toogleimg').on('mouseout', function(){
	var id = $(this).children('span').attr('id');
	$('.img_'+id).css('display', 'none');
});

$('.grafana').on('click', function(){
	open ($ (this) .data ('href'));
});

$('.detalhes').on('click', function(){
	open ($ (this) .data ('href'));
});

$('.relatorio').on('click', function(){
	open ($ (this) .data ('href'));
});

</script>