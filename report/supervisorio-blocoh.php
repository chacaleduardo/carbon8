<head>
 <meta http-equiv="X-UA-Compatible" content="IE=EDGE"/>
 <meta http-equiv="Content-Type" content="text/html;"/>
 <meta name="Generator" content="Xara HTML filter v.8.1.1.474"/>
 <meta name="XAR Files" content="supervisorio/blocoh/xr_files.txt"/>
 <title>blocoh</title>
 <meta name="viewport" content="width=device-width, initial-scale=1" />
 <link rel="stylesheet" type="text/css" href="supervisorio/blocoh/xr_fonts.css"/>
 <script type="text/javascript"><!--
 if(navigator.userAgent.indexOf('MSIE')!=-1 || navigator.userAgent.indexOf('Trident')!=-1){ document.write('<link rel="stylesheet" type="text/css" href="supervisorio/blocoh/xr_fontsie.css"/>');}
 --></script>
 <script language="JavaScript" type="text/javascript">document.documentElement.className="xr_bgh0";</script>
 <link rel="stylesheet" type="text/css" href="supervisorio/blocoh/xr_main.css"/>
 <link rel="stylesheet" type="text/css" href="supervisorio/blocoh/xr_text.css"/>
 <link rel="stylesheet" type="text/css" href="supervisorio/blocoh/custom_styles.css"/>
 <script type="text/javascript" src="supervisorio/blocoh/roe.js"></script>
 <script type="text/javascript" src="supervisorio/blocoh/replaceMobileFonts.js"></script>
<script src="../inc/js/jquery/jquery-1.11.2.min.js"></script>
 <link rel="stylesheet" type="text/css" href="supervisorio/blocoh/ani.css"/>
</head>
<div style="color: #333;font-size: 18px; float: right;"><?=date("d/m/Y H:i:s");?><br>
 <span id="referencia"></span>

</div>
<div id="xr_td" class="xr_td">
	<div class="xr_ap xr_xri_" style="width: 1000px; height: 760px;">
		<img class="xr_rn_ xr_ap" src="supervisorio/blocoh/3.png" title="" style="left: 0px; top: 66px; width: 1000px; height: 644px;"/>

		<a class="toogleimg">
			<span class="xr_ar 2048" style="left: 64px; top: 216px; width: 60px; height: 19px; background-color: #F8BB00; border: 1px solid #333333;" id="2048"></span>
			<div class="Normal_text" style="position: absolute; left:73px; top:231px; width:24px; height:10px;color:#333333;">
				<span class="xr_tl Normal_text" style="top: -11.77px;color:#333333;font-size:12px;" id="content_2048"></span>
			</div>
			<div class="Normal_text  grafana" style="position: absolute;  left:67px; top: 240px; width:24px; height:10px;color:#333333; z-index:9999" data-href="">
				<img class="img_2048" src="supervisorio/grafana.png"  style="display:none;"/>		
			</div>
			<div class="Normal_text  detalhes" style="position: absolute;  left:89px; top: 241px; width:24px; height:10px;color:#333333; z-index:9999" data-href=""> 
				<img href="" class="img_2048" src="supervisorio/detalhes.png"  style="display:none;"/>	
			</div>
			<div class="Normal_text  relatorio" style="position: absolute; left:106px; top: 240px; width:24px; height:10px;color:#333333; z-index:9999" data-href=""> 
				<img href="" class="img_2048" src="supervisorio/relatorio.png"  style="display:none;"/>	
			</div>
			<span class="img_2048" style=" position: absolute; left:64px; top:243px; width: 60px; height: 19px; background-color: #fff; border: 1px solid #333333; margin-top:-5px; display:none;"></span>
		</a>

		<a class="toogleimg">
			<span class="xr_ar 2044" style="left: 414px; top: 321px; width: 60px; height: 19px; background-color: #F8BB00; border: 1px solid #333333;" id="2044"></span>
			<div class="Normal_text" style="position: absolute; left:423px; top:336px; width:24px; height:10px;color:#333333;">
				<span class="xr_tl Normal_text" style="top: -11.77px;color:#333333;font-size:12px;" id="content_2044"></span>
			</div>
			<div class="Normal_text  grafana" style="position: absolute;  left:417px; top: 345px; width:24px; height:10px;color:#333333; z-index:9999" data-href="">
				<img class="img_2044" src="supervisorio/grafana.png"  style="display:none;"/>		
			</div>
			<div class="Normal_text  detalhes" style="position: absolute;  left:439px; top: 346px; width:24px; height:10px;color:#333333; z-index:9999" data-href=""> 
				<img href="" class="img_2044" src="supervisorio/detalhes.png"  style="display:none;"/>	
			</div>
			<div class="Normal_text  relatorio" style="position: absolute; left:456px; top: 345px; width:24px; height:10px;color:#333333; z-index:9999" data-href=""> 
				<img href="" class="img_2044" src="supervisorio/relatorio.png"  style="display:none;"/>	
			</div>
			<span class="img_2044" style=" position: absolute; left:414px; top:348px; width: 60px; height: 19px; background-color: #fff; border: 1px solid #333333; margin-top:-5px; display:none;"></span>
		</a>

		<a class="toogleimg">
			<span class="xr_ar 2076" style="left: 722px; top: 319px; width: 60px; height: 19px; background-color: #F8BB00; border: 1px solid #333333;" id="2076"></span>
			<div class="Normal_text" style="position: absolute; left:731px; top:334px; width:24px; height:10px;color:#333333;">
				<span class="xr_tl Normal_text" style="top: -11.77px;color:#333333;font-size:12px;" id="content_2076"></span>
			</div>
			<div class="Normal_text  grafana" style="position: absolute;  left:725px; top:343px; width:24px; height:10px;color:#333333; z-index:9999" data-href="">
				<img class="img_2076" src="supervisorio/grafana.png"  style="display:none;"/>		
			</div>
			<div class="Normal_text  detalhes" style="position: absolute;  left:747px; top:344px; width:24px; height:10px;color:#333333; z-index:9999" data-href=""> 
				<img href="" class="img_2076" src="supervisorio/detalhes.png"  style="display:none;"/>	
			</div>
			<div class="Normal_text  relatorio" style="position: absolute; left:764px; top:343px; width:24px; height:10px;color:#333333; z-index:9999" data-href=""> 
				<img href="" class="img_2076" src="supervisorio/relatorio.png"  style="display:none;"/>	
			</div>
			<span class="img_2076" style=" position: absolute; left:722px; top:346px; width: 60px; height: 19px; background-color: #fff; border: 1px solid #333333; margin-top:-5px; display:none;"></span>
		</a>

		<a class="toogleimg">
			<span class="xr_ar 2045" style="left: 467px; top: 450px; width: 60px; height: 19px; background-color: #F8BB00; border: 1px solid #333333;" id="2045"></span>
			<div class="Normal_text" style="position: absolute; left:475px; top:465px; width:24px; height:10px;color:#333333;">
				<span class="xr_tl Normal_text" style="top: -11.77px;color:#333333;font-size:12px;" id="content_2045"></span> 
			</div>
			<div class="Normal_text  grafana" style="position: absolute; left:470px; top:475px; width:24px; height:10px;color:#333333; z-index:9999" data-href="">
				<img class="img_2045" src="supervisorio/grafana.png"  style="display:none;"/>		
			</div>
			<div class="Normal_text  detalhes" style="position: absolute; left:492px; top:476px; width:24px; height:10px;color:#333333; z-index:9999" data-href=""> 
				<img class="img_2045" src="supervisorio/detalhes.png"  style="display:none;"/>
			</div>
			<div class="Normal_text  relatorio" style="position: absolute; left:510px; top:475px; width:24px; height:10px;color:#333333; z-index:9999" data-href="">  
				<img href="" class="img_2045" src="supervisorio/relatorio.png"  style="display:none;"/>	
			</div>
			<span class="img_2045" style=" position: absolute; left:467px; top:477px; width: 60px; height: 19px; background-color: #fff; border: 1px solid #333333; margin-top:-5px; display:none;"></span>
		</a>

		<a class="toogleimg">
			<span class="xr_ar 2376" style="left: 100px; top: 491px; width: 60px; height: 19px; background-color: #F8BB00; border: 1px solid #333333;" id="2376"></span>
			<div class="Normal_text" style="position: absolute; left:109px; top:506px; width:24px; height:10px;color:#333333; ">
				<span class="xr_tl Normal_text" style="top: -11.77px;color:#333333;font-size:12px;" id="content_2376"></span>
			</div>
			<div class="Normal_text  grafana" style="position: absolute; left:102px; top:516px; width:24px; height:10px;color:#333333; z-index:9999" data-href="">
				<img class="img_2376" src="supervisorio/grafana.png"  style="display:none;"/> 
			</div>
			<div class="Normal_text  detalhes" style="position: absolute; left:124px; top:517px; width:24px; height:10px;color:#333333; z-index:9999" data-href=""> 
				<img class="img_2376" src="supervisorio/detalhes.png"  style="display:none;"/>	
			</div>
			<div class="Normal_text  relatorio" style="position: absolute; left:141px; top:516px; width:24px; height:10px;color:#333333;z-index:9999" data-href=""> 
				<img class="img_2376" src="supervisorio/relatorio.png"  style="display:none;"/>	
			</div>
			<span class="img_2376" style=" position: absolute; left:100px; top:518px; width: 60px; height: 19px; background-color: #fff; border: 1px solid #333333; margin-top:-5px; display:none;"></span>
		</a>
	</div>
</div>

<?

include_once("../inc/php/functions.php");

if($_GET['elemento'] == 'pressao'){
	$variavel = 'LN7UYUJMz';
}else if($_GET['elemento'] == 'temperatura' || ($_GET['elemento'] == 'umidade')){
	$variavel = 'z8ZZMMJGk';
}

$getsala = $_GET['sala'];

$sql = "select 
			d.iddevice, s.idtag,
		IF(s.idtag = '".$getsala."','selecionada','') as salaselecionada
		FROM
			tag s
		join tagsala ts on ts.idtagpai = s.idtag
		join device d on d.idtag = ts.idtag
		WHERE
			s.idtag in (2048,2376,2076,2045,2044)
		and d.status = 'ATIVO'
		and s.status = 'ATIVO'";

$res = d::b()->query($sql);

while ($linha = mysql_fetch_assoc($res))
{
	if ($_GET['elemento'] == 'pressao')
	{
		$sql = "Select 
				dhr.registradoem, if (dhr.registradoem < (NOW() - INTERVAL 5 MINUTE), 'INATIVO', 'ATIVO') as statusleitura,
				ROUND(IF(dhr.pressao > 0 AND dhrr.pressao > 0,
							(dhr.pressao + d.calib_press) - (dhrr.pressao + dr.calib_press),
							0),
						0) AS pressao
				FROM
				laudo.devicehistref dhr
					JOIN
				laudo.device d ON d.iddevice = dhr.iddevice
					JOIN
				laudo.devicehistref dhrr ON dhrr.iddevice = dhr.iddeviceref
					AND dhr.registradoem = dhrr.registradoem
					JOIN
				laudo.device dr ON dr.iddevice = dhrr.iddevice
				WHERE
				d.iddevice = ".$linha['iddevice']."
				ORDER BY dhr.registradoem DESC
				LIMIT 1";

	}else if ($_GET['elemento'] == 'temperatura')
	{
		$sql = "Select
				ROUND(dh.temperatura - calib_temp,0) AS temperatura, dh.registradoem, if (registradoem < (NOW() - INTERVAL 5 MINUTE), 'INATIVO', 'ATIVO') as statusleitura
				FROM
					laudo.devicehist dh
						JOIN
					laudo.device d ON d.mac_address = dh.mac_address
				WHERE
					d.iddevice = ".$linha['iddevice']."
				ORDER BY dh.registradoem DESC
				LIMIT 1";
	}else if ($_GET['elemento'] == 'umidade')
	{ 
		$sql = "Select
				ROUND(dh.umidade - calib_umid,0) AS umidade, dh.registradoem, if (registradoem < (NOW() - INTERVAL 5 MINUTE), 'INATIVO', 'ATIVO') as statusleitura
				FROM
					laudo.devicehist dh
						JOIN
					laudo.device d ON d.mac_address = dh.mac_address
				WHERE
					d.iddevice = ".$linha['iddevice']."
				ORDER BY dh.registradoem DESC
				LIMIT 1";
	}

	$res2 = d::b()->query($sql);

	while ($_row = mysql_fetch_assoc($res2))
	{ 
		$idtagpai = $linha['idtag']; 
		$statusleitura = $_row['statusleitura'];
		$registradoem = $_row['registradoem'];
		$iddevice = $linha['iddevice'];
		$bgcolor='#F8BB00';

		if ($_GET['elemento'] == 'temperatura'){
			$temperatura = $_row['temperatura'];
			$dado = $temperatura.' °C';
		}else if ($_GET['elemento'] == 'pressao'){
			$pressao = $_row['pressao'];
			$dado = $pressao.' Pa';  
		}elseif ($_GET['elemento'] == 'umidade'){ 
			$umidade = $_row['umidade']; 
			$dado = $umidade.' UR';
		}
		
		if ($statusleitura == 'INATIVO'){
			$pressao = '------'; 
			$temperatura = '------'; 
			$umidade = '------';
			$bgcolor='#e74a3b';
		}

		if ($linha['salaselecionada'] == "selecionada"){
			$bgcolor='#07fca2';
		}
		
		?>
		<script>
			$('#referencia').html('<small>Referência: tag-<?='1793';?> <?=$referencia;?></small>');
			$('.<?=$idtagpai;?>').css('background', '<?=$bgcolor;?>');
			$('#content_<?=$idtagpai;?>').html('<?=$dado;?>');
		</script>
		<?
	}

	?>
	<script>
		$('#<?=$idtagpai;?>').siblings('.grafana').attr('data-href','http://h1.laudo.io:480/graph/d/<?=$variavel?>/bloco-h-<?=$_GET['elemento']?>?orgId=1').attr('title', 'Grafana');
		$('#<?=$idtagpai;?>').siblings('.detalhes').attr('data-href','https://sislaudo.laudolab.com.br/?_modulo=device&_acao=u&iddevice=<?=$iddevice;?>').attr('title', 'Editar Device');
		$('#<?=$idtagpai;?>').siblings('.relatorio').attr('data-href','https://sislaudo.laudolab.com.br/?_modulo=device').attr('title', 'Relatório Device');
	</script>

	<?
}
?>

<script>

$('.toogleimg').on('mouseover', function(){
	var id = $(this).children('span').attr('id');
	$('.img_'+id).css('display', '');
});
$('.toogleimg').on('mouseout', function(){
	var id = $(this).children('span').attr('id');
	$('.img_'+id).css('display', 'none');
});

$('.grafana').on('click', function(){
	open ($ (this) .data ('href'));
});

$('.detalhes').on('click', function(){
	open ($ (this) .data ('href'));
});

$('.relatorio').on('click', function(){
	open ($ (this) .data ('href'));
});

</script>