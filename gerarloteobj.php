<?
require("./inc/php/functions.php");

$qr1 = "SELECT lo.idloteobj,lo.idlote,lo.idloteativ,lo.idobjeto,lo.tipoobjeto,la.idprativ,la.ord
            from lote l join prodserv p on (p.idprodserv = l.idprodserv) join loteativ la on (l.idlote = la.idlote) 
            join loteobj lo on (lo.idloteativ = la.idloteativ)
            where 
            lo.tipoobjeto = 'tag' and
            l.status in ('APROVADO', 'QUARENTENA') and 
            p.especial = 'Y' and p.venda = 'Y' and
            l.idlote in (99986,100014,100019,100025,100033,100041,100043,100047,100051,100053,100070,100077,100080,100086,100095,100096,100097,
            100098,100099,100108,100117,100120,100126,100128,100140,100172,100176,100177,100179,100180,100181,100182,100184,100185,100186,100187,
            100188,100189,100190,100193,100194,100203,100205,100207,100216,100241,100248,100249,100252,100254,100264,100265,100271,100314,100315,
            100317,100318,100319,100321,100323,100326,100345,100352,100359,100371,100378,100385,100386,100387,100388,100401,100403,100406,100415,
            100423,100424,100425,100426,100427,100428,100442,100445,100446,100448,100450,100454,100455,100457,100458,100460,100461,100463,100472,
            100473,100475,100476,100477,100478,100479,100480,100488,100499,100500,100503,100508,100520,100530,100537,100540,100541,100555,100556,
            100558,100559,100560,100561,100562,100563,100564,100565,100566,100567,100568,100569,100578,100579,100598,100644,100651,100655,100661,
            100663,100667,100668,100702,100704,100708,100712,100718,100719,100726,100740,100742,100743,100744,100745,100746,100749,100750,100782,
            100787,100790,100804,100805,100809,100810,100829,100841,100853,100855,100879,100884,100886,100892,100893,100894,100895,100896,100901,
            100911,100915,100916,100917,100918,100919,100921,100923,100940,100943,100946,100956,100960,100961,100965,100975,100986,101080,101085,
            101091,101093,101094,101100,101109,101112,101114,101118,101119,101120,101128,101129,101130,101132,101133,101142,101143,101146,101147,
            101148,101152,101153,101155,101156,101158,101159,101161,101163,101165,101174,101180,101187,101194,101200,101213,101220,101222,101236,
            101237,101240,101243,101246,101257,101263,101268,101269,101270,101271,101272,101273,101274,101275,101276,101278,101280,101281,101282,
            101283,101284,101285,101287,101288,101290,101291,101294,101304,101306,101322,101324,101326,101328,101337,101348,101349,101350,101351,
            101354,101356,101362,101371,101382,101385,101405,101406,101411,101412,101413,101414,101415,101420,101421,101424,101425,101427,101428,
            101431,101432,101434,101436,101438,101439,101441,101442,101446,101450,101495,101497,101499,101500,101501,101502,101503,101504,101506,
            101507,101509,101511,101512,101513,101517,101518,101519,101520,101521,101522,101524,101541,101546,101551,101558,101559,101567,101571,
            101573,101574,101575,101576,101577,101578,101579,101581,101585,101587,101589,101591,101597,101598,101606,101658,101659,101660,101661,
            101662,101663,101664,101665,101666,101667,101670,101672,101680,101682,101683,101684,101686,101689,101690,101691,101692,101693,101694,
            101695,101697,101699,101700,101707,101709,101712,101713,101717,101718,101723,101727,101731,101732,101744,101756,101769,101770,101771,
            101772,101773,101775,101776,101777,101778,101779,101782,101784,101785,101786,101787,101788,101789,101790,101801,101803,101806,101807,
            101821,101822,101823,101831,101832,101837,101838,101839,101840,101841,101849,101857,101864,101868,101869,101911,101927,101929,101955,
            101956,101957,101959,101960,101961,101964,101966,101967,101968,101969,101970,101971,101974,101980,101981,101983,101984,102025,102027,
            102038,102039,102042,102061,102063,102064,102069,102070,102071,102073,102076,102082,102090,102094,102107,102110,102111,102119,102130,
            102132,102200,102202,102203,102206,102207,102208,102210,102251,102255,102256,102257,102258,102278,102284,102288,102289,102299,102305,
            102312,102322,102323,102324,102360,102364,102367,102369,102370,102392,102409,102417,102421,102438,102439,102478,102493,102497,102500,
            102503,102545,102547,102549,102551,102560,102565,102567,102598,102605,102610,102631,102658,102691,102721,102766,102794,102815,102816,
            102827,102829,102849,102855,102861,102892,102913,102915,102921,102948,102955,102957,102958,102960,102961,102969,102972,102974,103010,
            103032,103034,103064,103078,103081,103083,103093,103101,103104,103106,103114,103121,103127,103165,103167,103168,103169,103293,103303,
            103306,103308,103310,103336,103344,103350,103365,103367,103369,103375,103377,103423,103424,103429,103441,103462,103463,103469,103471,
            103472,103513,103535,103536,103548,103550,103551,103556,103558,103560,103565,103579,103585,103593,103599,103601,103603,103605,103607,
            103612,103620,103625,103633,103634,103635,103637,103638,103649,103650,103654,103669,103670,103695,103696,103698,103749,103780,103783,
            103785,103786,103802,103803,103804,103811,103832,103870,103871,103884,103898,103899,103900,103906,103938,103939,103945,103951,103963,
            103965,103966,103968,103975,103976,103985,104022,104024,104025,104068,104069,104071,104072,104074,104075,104087,104093,104131,104142,
            104149,104169,104173,104174,104176,104177,104187,104205,104206,104214,104237,104239,104242,104247,104269,104272,104305,104313,104316,
            104325,104328,104331,104337,104361,104362,104363,104364,104389,104440,104441,104452,104489,104492,104494,104499,104521,104535,104546,
            104553,104554,104556,104557,104558,104563,104566,104567,104571,104589,104590,104591,104612,104617,104658,104659,104711,104714,104742,
            104750,104752,104756,104764,104820,104822,104864,104870,104907,104908,104921,104932,104933,104934,104944,104990,104991,104999,105000,
            105001,105004,105006,105008,105016,105017,105041,105066,105071,105099,105123,105135,105137,105146,105147,105151,105156,105176,105177,
            105182,105186,105187,105270,105272,105304,105309,105314,105326,105384,105387,105409,105431,105432,105437,105439,105459,105461,105462,
            105468,105557,105569,105571,105575,105583,105584,105589,105590,105624,105640,105708,105713,105717,105723,105757,105791,105806,105807,
            105809,105814,105815,105816,105817,105820,106012,106013,106045,106051,106075,106083,106086,106087,106101,106113,106115,106253,106254,
            106255,106256,106260,106266,106267,106270,106271,106272,106273,106274,106275,106276,106277,106278,106280,106287,106294,106295,106297,
            106300,106302,106304,106305,106308,106309,106311,106318,106364,106371,106376,106379,106414,106418,106422,106425,106426,106438,106440,
            106441,106444,106454,106476,106477,106493,106500,106503,106504,106507,106510,106511,106517,106521,106522,106531,106548,106565,106567,
            106582,106584,106586,106587,106589,106596,106680,106681,106682,106683,106684,106686,106687,106688,106689,106717,106732,106740,106741,
            106744,106746,106756,106768,106786,106793,106797,106823,106831,106832,106833,106834,106836,106855,106858,106864,106866,106960,106974,
            106993,107036,107037,107038,107040,107096,107097,107098,107110,107136,107169,107172,107187,107188,107195,107202,107230,107238,107243,
            107244,107245,107295,107329,107332,107334,107348,107350,107351,107355,107361,107403,107414,107420,107491,107498,107500,107502,107510,
            107516,107535,107595,107596,107597,107611,107613,107615,107616,107617,107625,107649,107651,107663,107665,107678,107682,107707,107715,
            107717,107862,107885,107895,107904,107926,107927,107939,107974,107975,107976,107993,107996,107997,108004,108007,108008,108012,108013,
            108030,108031,108056,108189,108191,108199,108216,108230,108232,108234,108235,108243,108244,108245,108246,108247,108256,108266,108350,
            108352,108374,108381,108397,108401,108402,108404,108406,108407,108408,108409,108495,108516,108517,108520,108573,108649,108651,108660,
            108667,108669,108676,108681,108688,108689,108690,108744,108752,108753,108766,108794,108820,108828,108831,108833,108842,108843,108863,
            108873,108875,108876,108877,108878,108879,108880,108881,108909,108919,108922,108942,108967,109104,109118,109138,109139,109142,109143,
            109150,109168,109169,109186,109241,109248,109278,109279,109282,109292,109293,109309,109312,109313,109397,109409,109428,109432,109451,
            109454,109455,109476,109519,109533,109590,109593,109594,109596,109598,109599,109603,109608,109609,109610,109613,109614,109618,109621,
            109623,109627,109628,109650,109655,109662,109667,109672,109677,109679,109680,109684,109685,109696,109709,109710,109715,109758,109759,
            109766,109770,109854,109855,109856,109857,109858,109859,109860,109861,109862,109863,109865,109867,109869,109871,109874,109876,109878,
            109881,109884,109887,109889,109891,109894,109896,109897,109898,109899,109900,109901,109902,109903,109904,109905,109906,109907,109908,
            109909,109910,109936,109938,109939,109940,109941,109942,109953,109957,109966,109967,109970,110008,110034,110036,110037,110039,110044,
            110045,110046,110067,110078,110096,110098,110099,110109,110111,110113,110114,110115,110116,110118,110120,110121,110122,110123,110194,
            110239,110255,110270,110280,110287,110288,110296,110297,110301,110302,110303,110304,110305,110306,110307,110308,110309,110310,110311,
            110312,110313,110314,110315,110316,110317,110326,110327,110333,110335,110340,110343,110347,110352,110368,110401,110425,110441,110442,
            110443,110444,110445,110447,110449,110450,110451,110455,110459,110492,110525,110528,110532,110533,110535,110540,110542,110569,110571,
            110572,110573,110575,110577,110595,110634,110661,110676,110677,110678,110682,110683,110684,110685,110686,110687,110693,110695,110696,
            110711,110714,110716,110717,110719,110721,110722,110728,110729,110730,110731,110732,110733,110734,110735,110737,110738,110739,110740,
            110742,110743,110744,110745,110746,110749,110750,110751,110752,110753,110755,110757,110758,110759,110784,110787,110789,110801,110802,
            110804,110806,110835,110836,110839,110849,110869,110900,110909,110912,110917,110919,110943,110944,110971,111080,111084,111086,111138,
            111140,111160,111161,111163,111175,111181,111213,111226,111231,111232,111238,111239,111293,111295,111296,111298,111299,111300,111302,
            111305,111306,111307,111308,111309,111310,111311,111312,111313,111314,111315,111316,111318,111319,111320,111321,111322,111327,111328,
            111329,111330,111331,111332,111333,111334,111336,111340,111346,111381,111382,111383,111384,111385,111386,111387,111388,111389,111390,
            111392,111393,111394,111395,111396,111397,111398,111399,111400,111401,111402,111403,111404,111405,111406,111407,111408,111409,111410,
            111411,111412,111413,111414,111415,111416,111417,111418,111419,111428,111429,111430,111433,111478,111503,111505,111510,111513,111574,
            111575,111576,111577,111578,111579,111580,111581,111582,111583,111584,111585,111586,111587,111588,111589,111590,111593,111594,111595,
            111596,111597,111598,111599,111600,111601,111602,111603,111604,111605,111606,111607,111609,111610,111611,111613,111614,111615,111616,
            111617,111626,111632,111635,111695,111711,111720,111725,111735,111748,111750,111849,111853,111924,111925,111929,112171,112174,112175,
            112176,112177,112179,112180,112181,112183,112187,112189,112190,112191,112230,112305,112310,112327,112329,112331,112336,112348,112433,
            112460,112473)
            group by lo.idloteativ,idobjeto
            order by lo.idlote asc,lo.idloteativ asc, lo.idobjeto desc;";
    
$rs1 = d::b()->query($qr1) or die("Erro ao consultar lotes");

$allQueries = "";
$arrLoteAtiv = array();

// Array de tags caso esteja desatualizado
// a chave do array corresponde a coluna "ord" da tabela "loteativ"
// o valor do array corresponde ao idtag da sala
$arrTags = array(
    1 => 1925,
    2 => 187,
    3 => 187,
    4 => 187,
    5 => 187,
    6 => 188,
    7 => 1354,
    8 => 1601,
    9 => 1935
);

while( $rw1 = mysqli_fetch_assoc($rs1) ){

    // Verifica se o loteativ já foi consultado, caso não fazer a rotina abaixo
    if( !in_array($rw1["idloteativ"], $arrLoteAtiv) ){

        array_push($arrLoteAtiv, $rw1["idloteativ"]);

        if( !empty($rw1["idobjeto"]) ){

            $qr2 = "SELECT 1 
                    from prativobjlote p join tag t on (t.idtagtipo = p.idobjeto) 
                    where p.tipoobjeto = 'tagtipo' and 
                        t.idtagclass = 2 and
                        p.idlote = ".$rw1["idlote"]." and
                        t.idtag = ".$rw1["idobjeto"]." and
                        p.idprativ = ".$rw1["idprativ"];
            $rs2 = d::b()->query($qr2) or die("Erro ao consultar prativobjlote. Sql:". $qr2);

            if( (mysqli_num_rows($rs2) == 0) and (!empty($arrTags[$rw1["ord"]])) ){

                $allQueries .= "UPDATE loteobj set idobjeto = ".$arrTags[$rw1["ord"]]." WHERE idloteobj = ".$rw1["idloteobj"].";\n";
            }

        }else if( !empty($arrTags[$rw1["ord"]]) ){

            $allQueries .= "INSERT INTO loteobj (`idempresa`,`idlote`,`idloteativ`,`idobjeto`,`tipoobjeto`,`criadopor`,`criadoem`,`alteradopor`,`alteradoem`) VALUES (1, ".$rw1["idlote"].", ".$rw1["idloteativ"].", ".$arrTags[$rw1["ord"]].", 'tag', 'evento469131', now(), 'evento469131', now());\n";

        }
        
    }

}

echo "<pre>".$allQueries."</pre>";

$res = d::b()->multi_query($allQueries) or die("gerarLoteObj: ".  mysqli_error(d::b()));

	/*
	 * Ao executar ->multi_query com ->query normal no mesmo script, o segundo não retornará erros
	 * Deve-se executar o flush primeiro usando ->next_result
	 * http://php.net/manual/pt_BR/mysqli.multi-query.php#102837
	 */
while (d::b()->next_result()) {;}
?>